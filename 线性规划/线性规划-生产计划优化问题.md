# 线性规划｜生产计划优化问题

## 问题背景

线性规划是运筹学中最基础也最实用的优化方法：

- **生产计划**：在资源有限的情况下，怎样安排生产让利润最大？
- **资源分配**：劳动力、原材料、设备时间怎样分配最合理？
- **投资组合**：有限资金怎样投资，既要收益高又要风险低？

本模块包含四个函数：建模求解、可视化、敏感性分析与报告生成。

## 核心代码实现

### 1. 生产计划求解：`solve_production_planning()`

**作用**：在劳动力和原材料限制下，计算三种产品的最优生产数量，让总利润最大。

**关键代码步骤**：

**步骤1：定义问题数据**

```python
import pulp

# 产品信息
products = ['产品A', '产品B', '产品C']
profit = [40, 30, 50]  # 每单位产品的利润（元）

# 资源需求：每生产1单位产品需要多少资源
labor_req = [2, 1, 3]      # 劳动力需求（小时/单位）
material_req = [1, 2, 1]   # 原材料需求（kg/单位）

# 资源限制：总共有多少资源可用
labor_available = 100      # 可用劳动力（小时）
material_available = 80    # 可用原材料（kg）
```

**步骤2：建立优化模型**

```python
# 创建最大化问题
prob = pulp.LpProblem("生产计划", pulp.LpMaximize)

# 决策变量：x[0], x[1], x[2] 分别表示产品A、B、C的生产数量
x = [pulp.LpVariable(f"x{i}", lowBound=0) for i in range(3)]

# 目标函数：最大化总利润
# 总利润 = 40*产品A数量 + 30*产品B数量 + 50*产品C数量
prob += pulp.lpSum([profit[i] * x[i] for i in range(3)])
```

**步骤3：添加约束条件**

```python
# 劳动力约束：生产所有产品消耗的劳动力不能超过可用劳动力
# 2*产品A + 1*产品B + 3*产品C ≤ 100小时
prob += pulp.lpSum([labor_req[i] * x[i] for i in range(3)]) <= labor_available

# 原材料约束：生产所有产品消耗的原材料不能超过可用原材料
# 1*产品A + 2*产品B + 1*产品C ≤ 80kg
prob += pulp.lpSum([material_req[i] * x[i] for i in range(3)]) <= material_available
```

**步骤4：求解和结果分析**

```python
# 求解：使用CBC求解器
prob.solve(pulp.PULP_CBC_CMD(msg=0))

# 获取最优解
solution = [x[i].varValue for i in range(3)]  # 最优生产数量
max_profit = pulp.value(prob.objective)       # 最大利润

# 计算资源利用率
labor_used = sum(labor_req[i] * solution[i] for i in range(3))
material_used = sum(material_req[i] * solution[i] for i in range(3))

print(f"最优生产方案:")
for i, product in enumerate(products):
    print(f"  {product}: {solution[i]:.2f} 单位")
print(f"最大利润: {max_profit:.2f} 元")
print(f"劳动力利用率: {labor_used/labor_available*100:.1f}%")
print(f"原材料利用率: {material_used/material_available*100:.1f}%")
```

**说明**：

- `LpProblem()`：创建优化问题，指定最大化或最小化目标。
- `LpVariable()`：决策变量，表示各产品的生产数量。
- `lpSum()`：求和函数，用于构建目标函数与约束。
- `lowBound=0`：变量下界，生产数量为非负数。
- `.varValue`：读取变量的最优值。

### 2. 结果可视化：`visualize_results()`

**作用**：把抽象的数字结果画成直观的柱状图。

**关键代码步骤**：

**步骤1：准备图表数据**

```python
import matplotlib.pyplot as plt

# 设置中文字体，确保图表标题和标签正确显示
setup_chinese_font()

# 创建图表
fig, ax = plt.subplots(1, 1, figsize=(8, 6))
```

**步骤2：绘制产量柱状图**

```python
# 绘制柱状图：每个产品一根柱子，高度表示生产数量
bars = ax.bar(products, solution, color=['#FF6B6B', '#4ECDC4', '#45B7D1'])

# 设置图表标题和标签
ax.set_title('最优生产计划', fontsize=14, fontweight='bold')
ax.set_ylabel('产量 (单位)')
ax.grid(True, alpha=0.3)  # 添加网格线，方便读数

# 在每根柱子顶部显示具体数值
for bar, value in zip(bars, solution):
    ax.text(bar.get_x() + bar.get_width()/2, bar.get_height() + 0.5,
           f'{value:.1f}', ha='center', va='bottom')
```

**步骤3：保存图表**

```python
# 保存为高质量PNG文件
plt.tight_layout()  # 自动调整布局
plt.savefig('linear_programming_results.png', dpi=300, bbox_inches='tight')
plt.close()  # 关闭图表，释放内存
```

**说明**：

- `bar()`：绘制柱状图，柱高表示生产数量。
- `color=['#FF6B6B', '#4ECDC4', '#45B7D1']`：设置柱子颜色以增强区分度。
- `text()`：在柱顶添加数值标签。
- `dpi=300`：高分辨率保存，确保图片清晰。

### 3. 敏感性分析：`sensitivity_analysis()`

**作用**：分析当产品利润发生变化时，对最优解和总利润的影响。

**关键代码步骤**：

**步骤1：设置分析参数**

```python
# 分析利润变化的影响：每个产品的利润上下浮动10%、20%
base_profits = [40, 30, 50]  # 原始利润
change_percentages = [-20, -10, 10, 20]  # 变化幅度
```

**步骤2：逐个产品分析**

```python
for i, product in enumerate(products):
    print(f"\n{product} 利润变化影响:")
  
    for change in change_percentages:
        # 计算新的利润系数
        new_profit = base_profits[i] * (1 + change/100)
    
        # 重新建立模型（只改变一个产品的利润）
        prob = pulp.LpProblem("敏感性分析", pulp.LpMaximize)
        x = [pulp.LpVariable(f"x{j}", lowBound=0) for j in range(3)]
    
        # 修改目标函数：只有一个产品的利润系数改变
        modified_profits = base_profits.copy()
        modified_profits[i] = new_profit
        prob += pulp.lpSum([modified_profits[j] * x[j] for j in range(3)])
    
        # 约束条件保持不变
        prob += pulp.lpSum([labor_req[j] * x[j] for j in range(3)]) <= labor_available
        prob += pulp.lpSum([material_req[j] * x[j] for j in range(3)]) <= material_available
    
        # 求解并比较结果
        prob.solve(pulp.PULP_CBC_CMD(msg=0))
        new_max_profit = pulp.value(prob.objective)
    
        print(f"  利润{change:+d}% → 总利润: {new_max_profit:.2f} 元 "
              f"(变化: {new_max_profit - max_profit:+.2f})")
```

**说明**：

- 敏感性分析：衡量参数变化对最优解与目标值的影响。
- `copy()`：复制列表，避免改变原始数据。
- `{change:+d}%`：格式化输出，显示变化方向。
- 重新建模：每次分析需重新求解以保证结果可靠。

### 4. 报告生成：`generate_report()`

**作用**：把技术结果转化成管理语言，生成决策报告。

**关键代码步骤**：

**步骤1：问题描述**

```python
print("线性规划优化报告")
print("🎯 问题描述:")
print("  • 优化目标: 最大化生产利润")
print("  • 决策变量: 三种产品的生产数量")
print("  • 约束条件: 劳动力和原材料限制")
```

**步骤2：最优解展示**

```python
print("最优解：")
for i, product in enumerate(products):
    print(f"  • {product}: {solution[i]:.2f} 单位")
print(f"  • 最大利润: {max_profit:.2f} 元")
```

**步骤3：资源利用分析**

```python
# 计算利用率
labor_util = labor_used / labor_available * 100
material_util = material_used / material_available * 100

print("资源利用情况：")
print(f"  • 劳动力利用率: {labor_util:.1f}%")
print(f"  • 原材料利用率: {material_util:.1f}%")
```

**步骤4：管理建议**

```python
print("管理建议：")
if labor_util > 95:
    print("  • 劳动力资源接近满负荷，建议考虑增加人力")
if material_util > 95:
    print("  • 原材料资源接近满负荷，建议优化采购计划")

# 找出最有价值的产品
max_profit_idx = profit.index(max(profit))
print(f"  • 单位利润最高产品: {products[max_profit_idx]} "
      f"({profit[max_profit_idx]} 元/单位)")
```

**说明**：

- 将数值结果整理为文字摘要。
- 给出管理建议，强调资源瓶颈与优先产品。
- 识别关键资源与高价值产品。

## 运行方法

### 运行所有功能

```bash
cd 线性规划
python linear_programming_demo.py
```

### 单独运行某个功能

```python
from linear_programming_demo import LinearProgrammingDemo
demo = LinearProgrammingDemo()

# 选择运行其中一个
solution, max_profit = demo.solve_production_planning()  # 求解
demo.visualize_results()                                # 可视化
demo.sensitivity_analysis()                             # 敏感性分析
demo.generate_report()                                  # 生成报告
```

## 输出结果说明

### 控制台输出

运行后会显示详细的求解过程和结果：

**生产计划求解**：

```
生产计划优化问题
产品利润：{'产品A': 40, '产品B': 30, '产品C': 50}
劳动力需求：{'产品A': 2, '产品B': 1, '产品C': 3}
原材料需求：{'产品A': 1, '产品B': 2, '产品C': 1}
可用劳动力：100 小时
可用原材料：80 kg

最优解：
  产品A：20.00 单位
  产品B：0.00 单位
  产品C：20.00 单位
  最大利润：1800.00 元

资源利用率：
  劳动力：100.0/100（100.0%）
  原材料：60.0/80（75.0%）
```

**敏感性分析**：

```
敏感性分析
1. 利润系数敏感性分析：

  产品 A 利润变化影响：
    利润 -20% → 总利润：1640.00 元（变化：-160.00）
    利润 -10% → 总利润：1720.00 元（变化：-80.00）
    利润 +10% → 总利润：1880.00 元（变化：+80.00）
    利润 +20% → 总利润：1960.00 元（变化：+160.00）
```

**优化报告**：

```
线性规划优化报告
问题描述：
  • 优化目标：最大化生产利润
  • 决策变量：三种产品的生产数量
  • 约束条件：劳动力与原材料限制

最优解：
  • 产品 A：20.00 单位
  • 产品 B：0.00 单位
  • 产品 C：20.00 单位
  • 最大利润：1800.00 元

管理建议：
  • 劳动力资源接近满负荷，建议考虑增加人力
  • 单位利润最高产品：产品 C（50 元/单位）
```

### 图表文件

运行后会生成 `linear_programming_results.png` 文件，包含：

**最优生产计划柱状图**：

- 横轴：三种产品（产品A、产品B、产品C）
- 纵轴：生产数量（单位）
- 柱子高度：表示最优生产数量
- 柱顶数字：显示精确的生产数量

## 算法原理简介

### 线性规划基本概念

- **目标函数**：要最大化或最小化的表达式（如总利润）
- **决策变量**：我们要决定的数值（如生产数量）
- **约束条件**：限制条件（如资源限制）
- **可行域**：满足所有约束的解的集合

### 单纯形法原理

- **基本思想**：从可行域的一个顶点开始，沿着边移动到相邻顶点
- **移动规则**：每次移动都要让目标函数值更好
- **最优性**：当没有更好的相邻顶点时，当前点就是最优解
- **几何意义**：线性规划的最优解总是在可行域的顶点上

### PuLP求解器

- **CBC求解器**：开源的混合整数线性规划求解器
- **自动选择**：PuLP会自动选择最合适的求解器
- **求解过程**：内部使用单纯形法或内点法

## 实际应用场景

### 生产计划优化

- **问题**：多种产品，有限资源，怎样安排生产？
- **解决方案**：用线性规划找到最优生产组合

### 投资组合优化

- **问题**：多种投资选择，资金有限，怎样分配？
- **解决方案**：在风险约束下最大化收益

### 物流配送优化

- **问题**：多个仓库配送多个客户，怎样最省成本？
- **解决方案**：用线性规划优化配送路线

### 人员排班优化

- **问题**：满足服务需求，怎样安排员工班次最省人力？
- **解决方案**：用线性规划优化排班计划

## 技术要点

### PuLP线性规划库

```python
import pulp

# 创建问题：最大化或最小化
prob = pulp.LpProblem("问题名称", pulp.LpMaximize)  # 或 LpMinimize

# 创建变量：连续变量
x = pulp.LpVariable("x", lowBound=0, upBound=100)

# 创建变量：整数变量
y = pulp.LpVariable("y", lowBound=0, cat='Integer')

# 创建变量：二进制变量
z = pulp.LpVariable("z", cat='Binary')

# 添加目标函数
prob += 3 * x + 2 * y

# 添加约束
prob += x + y <= 10
prob += 2 * x - y >= 5

# 求解
prob.solve()

# 获取结果
print(f"x = {x.varValue}")
print(f"目标函数值 = {pulp.value(prob.objective)}")
```

### 常用函数说明

```python
# lpSum：求和函数，用于构建线性表达式
pulp.lpSum([coeff[i] * var[i] for i in range(n)])

# LpStatus：求解状态
status = prob.status
if status == pulp.LpStatusOptimal:
    print("找到最优解")
elif status == pulp.LpStatusInfeasible:
    print("无可行解")
elif status == pulp.LpStatusUnbounded:
    print("无界解")

# value：获取表达式的值
obj_value = pulp.value(prob.objective)
constraint_value = pulp.value(x + y)
```

### 图表可视化

```python
# 设置中文字体
setup_chinese_font()

# 统一样式
plt.style.use('seaborn-v0_8')

# 柱状图
plt.bar(labels, values, color=['#FF6B6B', '#4ECDC4', '#45B7D1'])

# 添加网格
plt.grid(True, alpha=0.3)

# 高质量保存
plt.savefig('filename.png', dpi=300, bbox_inches='tight')
```

## 扩展思考

### 模型改进方向

1. **多目标优化**：同时考虑利润最大化和风险最小化
2. **随机规划**：考虑需求和价格的不确定性
3. **整数规划**：当决策变量必须是整数时
4. **动态规划**：考虑多期决策问题

### 实际应用注意事项

1. **数据质量**：确保输入数据准确可靠
2. **模型验证**：检查模型是否符合实际情况
3. **敏感性分析**：了解参数变化对结果的影响
4. **实施可行性**：考虑实际执行中的约束
